{% load static %} 
{% load form_tags %}

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Crear una nueva orden de trabajo para gestionar tareas y recursos."
    />
    <meta name="theme-color" content="#0a0a0a" />
    <title>Crear Nueva Orden</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{% static 'css/styles-dark-elegante.css' %}?v=2"
    />
    <link rel="manifest" href="{% static 'manifest.json' %}" />
    <meta name="theme-color" content="#0a0a0a">
    <link rel="icon" href="{% static 'icons/icon-192.png' %}" sizes="192x192">

    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="{% static 'icons/icon-192.png' %}"
    />
  </head>

  <body>
    <div class="container mt-5 mb-5">
      <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">Crear Nueva Orden de Trabajo</h3>
        </div>
        <div class="card-body">
          <form
            method="post"
            enctype="multipart/form-data"
            action="{% url 'crear_orden' %}"
            id="form-orden"
          >
            {% csrf_token %}

            <h4 class="mb-3">Datos de la Orden</h4>
            <div class="row gy-3">
              <div class="col-md-4">
                {{ orden_form.fecha.label_tag }}{{ orden_form.fecha }}
              </div>
              <div class="col-md-4">
                {{ orden_form.horaInicio.label_tag }}{{ orden_form.horaInicio }}
              </div>
              <div class="col-md-4">
                {{ orden_form.horaFin.label_tag }}{{ orden_form.horaFin }}
              </div>
            </div>

            <div class="row gy-3 mt-3">
              <div class="col-md-6">
                {{ orden_form.tablero.label_tag }}{{ orden_form.tablero }}
              </div>
              <div class="col-md-6">
                {{ orden_form.circuito.label_tag }}{{ orden_form.circuito }}
              </div>
              <div class="col-md-6">
                {{ orden_form.zona.label_tag }}{{ orden_form.zona }}
              </div>
              <div class="col-md-6">
                {{ orden_form.vehiculo.label_tag }}{{ orden_form.vehiculo }}
              </div>
            </div>

            <div class="row gy-3 mt-3">
              <div class="col-md-4">
                {{ orden_form.kmInicial.label_tag }}{{ orden_form.kmInicial }}
              </div>
              <div class="col-md-4">
                {{ orden_form.kmFinal.label_tag }}{{ orden_form.kmFinal }}
              </div>
            </div>

            <div class="mt-3">
              {{ orden_form.descripcion.label_tag }}{{ orden_form.descripcion }}
            </div>

            <hr class="my-4" />

            <h5 class="mb-3">T√©cnicos</h5>
            <div id="tecnicos-container" class="mb-2"></div>
            <button
              type="button"
              class="btn btn-outline-primary btn-sm mb-3"
              id="agregar-tecnico"
            >
              + Agregar T√©cnico
            </button>

            <hr class="my-4" />

            <h5>Materiales Utilizados</h5>
            {{ material_formset.management_form }}
            <div id="material-forms">
              {% for form in material_formset %}
              <div class="row g-2 mb-2 material-form">
                {% for field in form.visible_fields %}
                <div class="col">
                  {{ field }} {% if field.name == "material" %}
                  <span class="unidad-material"></span>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
              {% endfor %}
            </div>

            <!-- Formulario vac√≠o oculto para clonar -->
            <div id="empty-material-form" class="d-none">
              <div class="row g-2 mb-2 material-form">
                {% for field in material_formset.empty_form.visible_fields %}
                <div class="col">
                  {{ field.as_widget }} {% if field.name == "material" %}
                  <span class="unidad-material"></span>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </div>

            <button
              type="button"
              class="btn btn-outline-secondary btn-sm"
              id="add-material"
            >
              Agregar Otro Material
            </button>

            <hr class="my-4" />

            <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-3">
              <button
                type="submit"
                name="action"
                value="generar"
                class="btn btn-primary"
              >
                Generar PDF
              </button>
              <button
                type="button"
                id="btn-descargar-pdf"
                class="btn btn-secondary"
              >
                Descargar PDF
              </button>
            </div>

            <a
              href="{% url 'lista_ordenes' %}"
              class="btn btn-outline-secondary mt-3"
              >‚Üê Volver a la Lista</a
            >
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
            let contadorTecnicos = 0;
            document.getElementById("agregar-tecnico").addEventListener("click", () => {
              const container = document.getElementById("tecnicos-container");
              const bloque = document.createElement("div");
              bloque.className = "row g-2 align-items-center mb-2";
              bloque.innerHTML = `
                <div class="col-md-5">
                  <input type="text" name="tecnicos[${contadorTecnicos}][nombre]" class="form-control" placeholder="Nombre del t√©cnico" required>
                </div>
                <div class="col-md-5">
                  <input type="text" name="tecnicos[${contadorTecnicos}][legajo]" class="form-control" placeholder="Legajo" required>
                </div>
                <div class="col-md-2">
                  <button type="button" class="btn btn-danger btn-sm eliminar">Eliminar</button>
                </div>
              `;
              bloque.querySelector(".eliminar").addEventListener("click", () => bloque.remove());
              container.appendChild(bloque);
              contadorTecnicos++;
            });

            $("#add-material").click(function () {
              const form_idx = $("#id_materialorden_set-TOTAL_FORMS").val();
              const new_form = $("#empty-material-form").html().replace(/__prefix__/g, form_idx);
              $("#material-forms").append(new_form);
              $("#id_materialorden_set-TOTAL_FORMS").val(parseInt(form_idx) + 1);
            });

            document.getElementById("btn-descargar-pdf").addEventListener("click", function (e) {
        e.preventDefault();  // üëà evitar comportamiento por defecto

        const form = document.getElementById("form-orden"); // üëà usar el ID correcto
        const formData = new FormData(form);
        formData.append("action", "descargar");

        fetch("{% url 'crear_orden' %}", {  // üëà usar la URL directamente
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": "{{ csrf_token }}",
          },
        })
          .then((response) => {
            if (!response.ok) throw new Error("Error en la descarga");
            return response.blob();
          })
          .then((blob) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "orden_trabajo.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
          })
          .catch((error) => alert("No se pudo descargar el PDF."));
      });


            document.addEventListener("DOMContentLoaded", function () {
              const unidades = {
                {% for material in materiales %}
                  "{{ material.id }}": "{{ material.unidad }}",
                {% endfor %}
              };

              function actualizarUnidad(select) {
                const unidadSpan = select.parentElement.querySelector(".unidad-material");
                const selectedId = select.value;
                if (unidadSpan) {
                  unidadSpan.textContent = unidades[selectedId] || "";
                }
              }

              document.querySelectorAll('select[name$="material"]').forEach(select => {
                select.addEventListener("change", () => actualizarUnidad(select));
                actualizarUnidad(select);
              });
            });
    </script>
  </body>
</html>
